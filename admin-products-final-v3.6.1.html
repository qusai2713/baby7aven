<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Baby Haven — لوحة المنتجات (v3.6.1)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#F6F7FB; --card:#FFFFFF; --ink:#33354D; --muted:#666A7A;
      --accent:#B6A8F7; --accent-ink:#5B4FCB;
      --ok:#34D399; --warn:#EAB308; --alert:#F97316; --danger:#F87171;
      --radius:16px; --bd:#E5E7EB;
      --shadow:0 5px 14px rgba(182,168,247,.15);
      --shadow-lg:0 9px 22px rgba(182,168,247,.22);
      --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{
      margin:0;padding:22px 12px;background:var(--bg);color:var(--ink);
      font-family:"Cairo","Tajawal",ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      line-height:1.55;
    }
    h1{margin:0 0 10px;text-align:center;color:#7C3AED;font-size:20px}
    .muted{color:var(--muted);text-align:center;margin-bottom:14px;font-size:13px}

    /* Toolbar */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:0 auto 6px;max-width:1200px}
    .toolbar input[type="search"]{
      flex:1 1 260px;background:#fff;border:1px solid var(--bd);border-radius:999px;padding:8px 12px;color:var(--ink);font-size:14px
    }
    .toolbar select{
      height:40px;border-radius:14px;background:#fff;border:1px solid var(--bd);padding:0 12px;font-weight:700;color:var(--ink)
    }
    .btn{height:40px;border-radius:14px;display:inline-flex;align-items:center;gap:8px;
      background:var(--accent);color:#fff;border:none;padding:0 14px;cursor:pointer;font-weight:800;box-shadow:var(--shadow);
      transition:.2s transform ease, .2s box-shadow ease,font-size .2s;font-size:14px}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--bd)}
    .btn.danger{background:var(--danger)}
    .btn.xs{height:32px;border-radius:10px;padding:0 10px;font-weight:700;font-size:13px}

    /* Section stats (under filters, left) */
    .secstats{max-width:1200px;margin:0 auto 12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
    .secstats .label{font-size:12px;color:var(--muted);margin-inline-end:4px;align-self:center}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .chip .n{min-width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;background:#EEF2FF;border:1px solid #E5E7EB;font-weight:800;font-size:12px;color:#1F2937}

    /* Grid + Card */
    .grid{display:grid;gap:var(--gap);grid-template-columns:repeat(2,1fr);max-width:1280px;margin:0 auto}
    @media(min-width:768px){.grid{grid-template-columns:repeat(4,1fr);}}
    @media(min-width:1200px){.grid{grid-template-columns:repeat(7,1fr);}}

    .card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;
      display:flex;flex-direction:column;transition:.2s ease;position:relative;
    }
    .card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg)}
    .media{position:relative;aspect-ratio:1/1;background:#EDECF4}
    .media img{width:100%;height:100%;object-fit:cover;transition:.35s}
    .card:hover img{transform:scale(1.03)}

    .info{padding:10px;display:flex;flex-direction:column;gap:8px;align-items:center;text-align:center}
    .qtypill-block{
      display:inline-block;background:#EEF2FF;color:#1F2937;border:1px solid #E5E7EB;border-radius:999px;
      padding:6px 12px;font-weight:800;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.04)
    }
    .qtypill-block.ok{background:#DCFCE7;color:#065F46;border-color:#86EFAC}
    .qtypill-block.warn{background:#FEF9C3;color:#78350F;border-color:#FDE68A}
    .qtypill-block.alert{background:#FFE4D5;color:#7C2D12;border-color:#FDBA74}
    .pname{font-size:12px;color:var(--muted);max-width:96%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .empty{max-width:980px;margin:10px auto;border:2px dashed #E5E7EB;border-radius:var(--radius);padding:20px;text-align:center;color:var(--muted);font-size:14px}

    /* Pager */
    .pager{max-width:1280px;margin:8px auto 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
    .pager .meta{font-size:12px;color:var(--muted);margin-inline:6px}
    .pager .pbtn{height:36px;min-width:36px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer;padding:0 10px}
    .pager .pbtn.active{background:rgba(182,168,247,.15);border-color:#D9D6FB;color:#5B4FCB;font-weight:800}

    /* Modal */
    .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999}
    .backdrop[aria-hidden="true"]{display:none!important}
    .modal{background:var(--card);color:var(--ink);width:min(96vw,960px);border-radius:18px;padding:10px;border:1px solid var(--bd);box-shadow:var(--shadow-lg)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-bottom:1px solid var(--bd)}
    .modal-body{max-height:70vh;overflow:auto;padding:10px 2px}
    .modal-footer{position:sticky;bottom:0;background:#fff;display:flex;gap:8px;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px solid var(--bd)}

    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:6px 12px;border-radius:999px;border:1px solid var(--bd);background:#fff;cursor:pointer;font-weight:800;font-size:13px}
    .tab.active{background:rgba(182,168,247,.15);color:var(--accent-ink);border-color:#D9D6FB}

    .row{display:grid;gap:8px;grid-template-columns:1fr}
    @media(min-width:900px){.row{grid-template-columns:1fr 1fr}}
    input[type="text"],input[type="number"],input[type="file"],textarea,select{
      width:100%;background:#fff;border:1px solid var(--bd);border-radius:12px;padding:8px 10px;color:var(--ink);font-size:14px
    }
    textarea{min-height:80px;resize:vertical}
    .mini-table{width:100%;border-collapse:collapse;margin-top:6px}
    .mini-table th,.mini-table td{border-bottom:1px solid var(--bd);padding:6px 8px;text-align:center;vertical-align:middle;font-size:13px}
    .thumb-sm{width:40px;height:40px;border-radius:10px;border:1px solid var(--bd);object-fit:cover;background:#EDECF4}
    .thumb-xs{width:48px;height:48px;border-radius:10px;border:1px solid var(--bd);object-fit:cover;background:#EDECF4;display:none}

    .var-row{display:grid;grid-template-columns:1.1fr .7fr .7fr auto;gap:6px;align-items:center;margin-top:6px}
    .var-row.size{grid-template-columns:1fr .7fr .7fr auto auto}
    .var-row input[type="text"], .var-row input[type="number"]{
      appearance:none;height:40px;line-height:24px;background:#fff;border:1px solid var(--bd);
      border-radius:12px;padding:8px 10px;font-size:14px;color:var(--ink);width:100%;
    }
    .file-inline{display:flex;align-items:center;gap:8px}

    code.sku{background:#F3F4F6;padding:2px 6px;border-radius:6px;border:1px solid #E5E7EB}

    [inert]{pointer-events:none;user-select:none}

    /* Toasts */
    .toast-wrap{position:fixed;inset-inline:0;bottom:16px;display:flex;justify-content:center;pointer-events:none;z-index:10000}
    .toast{pointer-events:auto;display:flex;align-items:center;gap:10px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.25);font-size:14px}
    .toast.success{background:#065F46}
    .toast.warn{background:#78350F}
    .toast.error{background:#7C2D12}
    .toast button{height:32px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:transparent;color:#fff;font-weight:800;padding:0 10px;cursor:pointer}
  </style>
</head>
<body>
  <h1>☁️ منتجات Baby Haven</h1>
  <p class="muted">v3.6.1 — عدّاد إجمالي لكل قسم تحت الفلاتر (يسار). تم حذف توليد SKU نهائيًا. باقي مزايا v3.6 كما هي.</p>

  <div class="toolbar">
    <input id="q" type="search" placeholder="ابحث باسم المنتج أو SKU…">
    <select id="fltType" title="نوع المنتج">
      <option value="all">كل الأنواع</option>
      <option value="simple">عادي</option>
      <option value="multi-color">متعدد (ألوان)</option>
      <option value="multi-size">متعدد (أحجام)</option>
    </select>
    <select id="fltSection" title="القسم"><option value="all">كل الأقسام</option></select>
    <select id="fltCategory" title="الفئة"><option value="all">كل الفئات</option></select>
    <select id="fltStock" title="حالة المخزون">
      <option value="all">كل الحالات</option>
      <option value="ok">متوفر</option>
      <option value="warn">منخفض</option>
      <option value="alert">وشك النفاد</option>
    </select>
    <select id="sortQty" title="ترتيب حسب الكمية">
      <option value="none">بدون ترتيب</option>
      <option value="qty-desc">الكمية تنازلي</option>
      <option value="qty-asc">الكمية تصاعدي</option>
    </select>
    <button id="btnAdd" class="btn" type="button">➕ إضافة منتج</button>
    <button id="btnExport" class="btn ghost" type="button">⬇️ تصدير JSON</button>
    <button id="btnImport" class="btn ghost" type="button">⬆️ استيراد JSON</button>
    <input id="fileImport" type="file" accept="application/json" style="display:none">
  </div>

  <!-- Section stats row -->
  <div id="secStats" class="secstats" aria-live="polite" hidden>
    <span class="label">إجمالي الأقسام:</span>
  </div>

  <section id="cards" class="grid" aria-live="polite"></section>
  <div id="empty" class="empty" hidden>لا توجد منتجات بعد — اضغط “إضافة منتج”.</div>
  <div id="pager" class="pager" hidden></div>

  <!-- Toast container -->
  <div class="toast-wrap" aria-live="polite" aria-atomic="true"></div>

  <!-- مودال التفاصيل + التعديل -->
  <div class="backdrop" id="bd" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="ttl">
      <div class="modal-header">
        <h3 id="ttl" style="margin:0;font-size:16px">تفاصيل المنتج</h3>
        <div class="tabs">
          <button class="tab active" data-pane="view" type="button">تفاصيل</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="pane-view"></div>
        <div id="pane-edit" style="display:none">
          <div class="row">
            <label>اسم المنتج <input id="fmName" type="text" required></label>
            <label>كود المنتج (SKU)
              <input id="fmSku" type="text" required>
            </label>
          </div>
          <div class="row">
            <label>القسم <input id="fmSection" type="text" placeholder="مثال: ملابس"></label>
            <label>الفئة <input id="fmCategory" type="text" placeholder="مثال: قمصان"></label>
          </div>
          <div id="simpleBox">
            <div class="row">
              <label>السعر <input id="fmPrice" type="number" step="0.001" placeholder="0.000"></label>
              <label>الكمية المتوفرة <input id="fmQty" type="number" step="1" placeholder="0"></label>
            </div>
            <div class="row">
              <label>وصف <textarea id="fmDesc" placeholder="وصف مختصر…"></textarea></label>
              <label>صورة المنتج (رفع من جهازك) <input id="fmImage" type="file" accept="image/*"><div style="margin-top:6px"><img id="fmPreview" alt="" class="thumb-sm" style="display:none"></div></label>
            </div>
          </div>
          <div class="row" style="align-items:center;margin-top:6px">
            <label class="inline"><input id="fmMulti" type="checkbox"> تفعيل تعدد (ألوان/أحجام)</label>
            <div id="multiControls" class="inline" style="display:none">
              <label class="inline" style="margin-inline-start:10px"><input type="radio" name="multiKind" value="color"> ألوان</label>
              <label class="inline"><input type="radio" name="multiKind" value="size"> أحجام</label>
            </div>
          </div>
          <div id="multiColorBox" style="display:none">
            <h4 style="margin:6px 0;font-size:14px">ألوان المنتج</h4>
            <div class="var-row">
              <strong style="font-size:12px">اللون</strong><strong style="font-size:12px">السعر</strong><strong style="font-size:12px">الكمية</strong><span style="font-size:12px">الصورة</span>
            </div>
            <div id="colorList"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:6px">
              <button id="btnColorAdd" class="btn xs" type="button">➕ إضافة لون</button>
            </div>
          </div>
          <div id="multiSizeBox" style="display:none">
            <h4 style="margin:6px 0;font-size:14px">أحجام المنتج</h4>
            <div class="var-row size">
              <strong style="font-size:12px">الحجم</strong><strong style="font-size:12px">السعر</strong><strong style="font-size:12px">الكمية</strong><span style="font-size:12px">الصورة</span><span></span>
            </div>
            <div id="sizeList"></div>
            <div style="display:flex;justify-content:flex-end;margin-top:6px">
              <button id="btnSizeAdd" class="btn xs" type="button">➕ إضافة حجم</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div id="viewBtns" style="display:flex;gap:8px;align-items:center">
          <div style="display:flex;gap:8px">
            <button class="btn" id="btnGoEdit" type="button">تعديل</button>
            <button class="btn ghost" id="btnCloseView" type="button">إغلاق</button>
          </div>
        </div>
        <div id="editBtns" style="display:none;gap:8px">
          <button class="btn" id="fmSave" type="button">حفظ</button>
          <button class="btn ghost" id="btnCancelEdit" type="button">إلغاء</button>
        </div>
        <button class="btn danger" id="btnDelete" type="button" title="حذف المنتج">حذف</button>
      </div>
    </div>
  </div>

  <!-- مودال تأكيد الحذف + نسخ SKU -->
  <div class="backdrop" id="bdDel" aria-hidden="true" style="z-index:10050; display:none">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="ttlDel">
      <div class="modal-header">
        <h3 id="ttlDel" style="margin:0;font-size:16px;color:#7C2D12">تأكيد الحذف</h3>
      </div>
      <div class="modal-body">
        <p style="margin:6px 0">هل أنت متأكد من حذف هذا المنتج؟ لا يمكن التراجع بعد التأكيد.</p>
        <div style="display:grid;gap:6px;grid-template-columns:1fr">
          <div><b>المنتج:</b> <span id="delName">—</span></div>
          <div><b>SKU:</b> <code id="delSku" class="sku"></code></div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content:flex-end">
        <button class="btn ghost" id="btnCopySku" type="button" title="نسخ كود المنتج">نسخ SKU</button>
        <button class="btn ghost" id="btnDelCancel" type="button">إلغاء</button>
        <button class="btn danger" id="btnDelConfirm" type="button">تأكيد الحذف</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";
    /* ==== Polyfills + Global error toast ==== */
    if(!Element.prototype.matches){
      Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector || function(sel){
        var nodes=(this.document || this.ownerDocument).querySelectorAll(sel), i=0;
        while(nodes[i] && nodes[i] !== this) i++;
        return Boolean(nodes[i]);
      };
    }
    if(!Element.prototype.closest){
      Element.prototype.closest = function(sel){
        var el=this;
        while(el && el.nodeType===1){ if(el.matches(sel)) return el; el = el.parentElement || el.parentNode; }
        return null;
      };
    }

    // ---------- Constants ----------
    var MAX_IMG_BYTES = 512 * 1024; // 512KB
    var MAX_IMG_DIM = 1024; // max width/height
    var PAGINATE_THRESHOLD = 60;
    var PAGE_SIZE = 30;

    // ---------- Utils ----------
    var $=function(s,p){return (p||document).querySelector(s)};
    var $$=function(s,p){return Array.prototype.slice.call((p||document).querySelectorAll(s));};
    function on(parent, evt, sel, fn){
      parent.addEventListener(evt, function(e){
        var t=e.target; while(t && t!==parent){ if(t.matches(sel)){ fn.call(t,e); return; } t=t.parentElement; }
      });
    }
    function toNum(x){ var n=parseFloat(x); return isNaN(n)?0:n; }
    function fmt(n){ var num=toNum(n||0); return num.toFixed(3)+' ر.ع'; }
    function esc(s){ return String(s||'').replace(/[&<>\"']/g, function(ch){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]; }); }
    function debounce(fn,ms){ var t=null; return function(){ var ctx=this, args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, ms||0); }; }

    // Read file then compress if needed -> returns dataURL
    function dataURLBytesLen(dataURL){
      try{ return Math.ceil((dataURL.length - dataURL.indexOf(',') - 1) * 3/4); }catch(_){return dataURL.length;}
    }
    function compressDataURL(img, type, quality){
      var w=img.naturalWidth, h=img.naturalHeight;
      var scale=Math.min(1, MAX_IMG_DIM/Math.max(w,h));
      var cw=Math.max(1, Math.round(w*scale)), ch=Math.max(1, Math.round(h*scale));
      var c=document.createElement('canvas'); c.width=cw; c.height=ch;
      var ctx=c.getContext('2d'); ctx.drawImage(img, 0, 0, cw, ch);
      return c.toDataURL(type||'image/jpeg', quality==null?0.8:quality);
    }
    function compressImageFile(file, cb){
      try{
        var url=URL.createObjectURL(file);
        var img=new Image();
        img.onload=function(){
          try{
            var quality=0.85, out=compressDataURL(img, 'image/jpeg', quality);
            var bytes=dataURLBytesLen(out);
            while(bytes>MAX_IMG_BYTES && quality>0.55){
              quality-=0.08;
              out=compressDataURL(img, 'image/jpeg', quality);
              bytes=dataURLBytesLen(out);
            }
            if(bytes>MAX_IMG_BYTES){
              toast('تعذر ضغط الصورة للحد المطلوب، تم استخدام أقل جودة متاحة.', {type:'warn'});
            }
            URL.revokeObjectURL(url);
            cb(out);
          }catch(err){ URL.revokeObjectURL(url); cb(''); }
        };
        img.onerror=function(){ URL.revokeObjectURL(url); cb(''); };
        img.src=url;
      }catch(err){ cb(''); }
    }
    function handleImageInput(file, cb){
      if(!file){ cb(''); return; }
      if(file.size<=MAX_IMG_BYTES){
        // ما يزال ممكن أن تكون الأبعاد كبيرة — سنضغط دائمًا لتوحيد الحد الأقصى للأبعاد
        compressImageFile(file, cb);
      }else{
        compressImageFile(file, cb);
      }
    }

    // ---------- Toasts ----------
    var toastWrap=$('.toast-wrap');
    function toast(msg, opts){
      opts=opts||{};
      var el=document.createElement('div');
      el.className='toast '+(opts.type||'');
      el.setAttribute('role','status');
      el.innerHTML = esc(msg) + (opts.actionText? ' <button class="toast-act">'+esc(opts.actionText)+'</button>':'');
      toastWrap.innerHTML=''; // single toast
      toastWrap.appendChild(el);
      var hide=function(){ if(el && el.parentNode){ el.parentNode.removeChild(el); } };
      if(opts.duration!==0){ setTimeout(hide, opts.duration||3000); }
      if(opts.onAction){
        var b=el.querySelector('.toast-act'); if(b){ b.addEventListener('click', function(){ opts.onAction(); hide(); }); }
      }
      return {hide:hide, el:el};
    }
    window.addEventListener('error', function(e){
      try{
        var msg=(e && e.message)?String(e.message):'خطأ غير متوقع';
        toast('خطأ: '+msg, {type:'error', duration:4000});
      }catch(_){}
    });

    // ---------- Store ----------
    var LS='bh_admin_products_final_v361';
    var Store={
      read:function(){ try{ return JSON.parse(localStorage.getItem(LS)||'[]'); } catch(e){ return []; } },
      write:function(arr){ try{ localStorage.setItem(LS, JSON.stringify(Array.isArray(arr)?arr:[])); } catch(e){} },
      upsert:function(item){
        var list=this.read(), idx=list.findIndex(function(p){ return String(p.sku||'').toLowerCase()===String(item.sku||'').toLowerCase(); });
        if(idx>=0) list[idx]=item; else list.unshift(item);
        this.write(list); return list;
      },
      remove:function(sku){
        var list=this.read().filter(function(p){ return String(p.sku||'').toLowerCase()!==String(sku||'').toLowerCase(); });
        this.write(list); return list;
      },
      seed:function(){
        var cur=this.read(); if(cur && cur.length) return;
        this.write([
          {type:'simple', section:'ملابس', category:'بطانيات', name:'بطانية قطنية', sku:'BH-BLKT-101', price:6.500, qty:5, desc:'لطيفة على بشرة الطفل', image:'', new:true},
          {type:'multi-color', section:'ملابس', category:'تيشيرتات', name:'تيشيرت أطفال', sku:'BH-TS-001', desc:'ألوان متعددة', colors:[
            {label:'أحمر', price:2.000, qty:2, image:''},
            {label:'أزرق', price:2.200, qty:3, image:''}
          ]},
          {type:'multi-size', section:'ملابس', category:'بناطيل', name:'بنطال أطفال', sku:'BH-PNT-010', desc:'أحجام متعددة', sizes:[
            {size:'S', price:1.500, qty:1, image:''},
            {size:'M', price:1.700, qty:2, image:''},
            {size:'L', price:1.900, qty:2, image:''}
          ]}
        ]);
      }
    };

    // ---------- Product helpers ----------
    var Product={
      qty:function(p){
        if(p.type==='simple') return toNum(p.qty||0);
        var key=p.type==='multi-color'?'colors':'sizes';
        return (p[key]||[]).reduce(function(a,v){ return a+toNum(v.qty||0); },0);
      },
      cover:function(p){
        if(p.type==='simple') return p.image||'';
        if(p.type==='multi-color') return (p.colors && p.colors[0] && p.colors[0].image) ? p.colors[0].image : '';
        if(p.type==='multi-size') return (p.sizes && p.sizes[0] && p.sizes[0].image) ? p.sizes[0].image : '';
        return '';
      },
      badge:function(q){ if(q>=10) return 'ok'; if(q>=3) return 'warn'; return 'alert'; }
    };

    // ---------- Filters/Sort/Pager state ----------
    var State={ q:'', type:'all', stock:'all', section:'all', category:'all', sort:'none', page:1 };

    function buildTaxonomyOptions(){
      var data=Store.read();
      var secs=new Set(), cats=new Set();
      data.forEach(function(p){ if(p.section) secs.add(String(p.section)); if(p.category) cats.add(String(p.category)); });
      var secSel=$('#fltSection'), catSel=$('#fltCategory');
      if(secSel){
        var cur=State.section||'all';
        var html='<option value="all">كل الأقسام</option>' + Array.from(secs).sort().map(function(s){ return '<option value="'+esc(s)+'"'+(cur===s?' selected':'')+'>'+esc(s)+'</option>'; }).join('');
        secSel.innerHTML=html;
      }
      if(catSel){
        var curc=State.category||'all';
        var htmlc='<option value="all">كل الفئات</option>' + Array.from(cats).sort().map(function(s){ return '<option value="'+esc(s)+'"'+(curc===s?' selected':'')+'>'+esc(s)+'</option>'; }).join('');
        catSel.innerHTML=htmlc;
      }
    }

    // Section stats (overall totals per section)
    function renderSectionStats(){
      var data=Store.read();
      var map={};
      data.forEach(function(p){
        var s=(p.section && String(p.section).trim())? String(p.section).trim() : 'غير مصنف';
        map[s]=(map[s]||0)+1;
      });
      var keys=Object.keys(map).sort();
      var cont=$('#secStats');
      if(!cont) return;
      if(!keys.length){ cont.hidden=true; cont.innerHTML='<span class="label">إجمالي الأقسام:</span>'; return; }
      var html='<span class="label">إجمالي الأقسام:</span>';
      html+=keys.map(function(k){
        return '<span class="chip"><span>'+esc(k)+'</span><span class="n">'+map[k]+'</span></span>';
      }).join(' ');
      cont.innerHTML=html;
      cont.hidden=false;
    }

    // ---------- Modal ----------
    var lastFocus=null, editDirty=false;
    function setDirty(){ editDirty=true; }
    function resetDirty(){ editDirty=false; }
    function canClose(){
      if($('#pane-edit').style.display!=='none' && editDirty){
        return confirm('لديك تعديلات غير محفوظة. هل تريد تجاهلها وإغلاق النافذة؟');
      }
      return true;
    }
    function openModal(){
      var bd=$('#bd'); if(!bd) return;
      lastFocus=document.activeElement; bd.removeAttribute('aria-hidden'); bd.style.display='flex'; $('#cards').setAttribute('inert',''); document.body.style.overflow='hidden';
      var first=bd.querySelector('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])'); setTimeout(function(){ (first||bd).focus(); },0);
      bd._handler=function(e){ if(e.key==='Escape'){ if(canClose()) closeModal(); } if(e.key==='Tab'){ trapTab(e,bd); } }; bd.addEventListener('keydown', bd._handler);
    }
    function closeModal(){
      var bd=$('#bd'); if(!bd) return;
      bd.setAttribute('aria-hidden','true'); bd.style.display='none'; $('#cards').removeAttribute('inert'); document.body.style.overflow='';
      if(bd._handler){ bd.removeEventListener('keydown', bd._handler); bd._handler=null; }
      if(lastFocus && lastFocus.focus) lastFocus.focus();
      resetDirty();
    }
    function trapTab(e,wrap){
      var sel='a[href],button:not([disabled]),input,select,textarea,[tabindex]:not([tabindex="-1"])';
      var list=Array.prototype.slice.call(wrap.querySelectorAll(sel)).filter(function(x){ return x.offsetParent!==null; });
      if(!list.length) return;
      var f=list[0], l=list[list.length-1];
      if(e.shiftKey && document.activeElement===f){ e.preventDefault(); l.focus(); }
      else if(!e.shiftKey && document.activeElement===l){ e.preventDefault(); f.focus(); }
    }

    // ---------- Rendering + Pagination ----------
    function cardHTML(p){
      var q=Product.qty(p);
      var imgSrc=Product.cover(p);
      var alt=esc(p.name||p.sku||'صورة منتج');
      var img=imgSrc ? '<img src="'+esc(imgSrc)+'" alt="'+alt+'">' : '<img src="https://picsum.photos/seed/fallback/800/800" alt="'+alt+'">';
      var cls='qtypill-block '+Product.badge(q);
      var name=esc(p.name||p.sku||'');
      return [
        '<article class="card" data-sku="'+esc(p.sku)+'">',
          '<div class="media">', img, '</div>',
          '<div class="info">',
            '<div class="'+cls+'">المتبقي: '+q+'</div>',
            '<div class="pname" title="'+name+'">'+name+'</div>',
            '<button class="btn xs ghost" data-act="details" aria-label="تفاصيل '+esc(p.sku)+'">تفاصيل</button>',
          '</div>',
        '</article>'
      ].join('');
    }
    var PAGINATE_THRESHOLD = 60, PAGE_SIZE = 30;
    function applyFilters(items){
      var list=items.slice();
      if(State.q){
        var v=State.q.toLowerCase();
        list=list.filter(function(p){
          return String(p.name||'').toLowerCase().indexOf(v)>-1 ||
                 String(p.sku||'').toLowerCase().indexOf(v)>-1 ||
                 String(p.type||'').toLowerCase().indexOf(v)>-1;
        });
      }
      if(State.type!=='all'){ list=list.filter(function(p){ return p.type===State.type; }); }
      if(State.section!=='all'){ list=list.filter(function(p){ return String(p.section||'')===String(State.section); }); }
      if(State.category!=='all'){ list=list.filter(function(p){ return String(p.category||'')===String(State.category); }); }
      if(State.stock!=='all'){
        list=list.filter(function(p){ return Product.badge(Product.qty(p))===State.stock; });
      }
      if(State.sort==='qty-desc'){ list.sort(function(a,b){ return Product.qty(b)-Product.qty(a); }); }
      else if(State.sort==='qty-asc'){ list.sort(function(a,b){ return Product.qty(a)-Product.qty(b); }); }
      return list;
    }
    function renderPager(total){
      var pager=$('#pager');
      if(total<=PAGINATE_THRESHOLD){ pager.hidden=true; pager.innerHTML=''; State.page=1; return {start:0, end:total}; }
      var pages=Math.max(1, Math.ceil(total/PAGE_SIZE));
      if(State.page>pages) State.page=pages;
      var start=(State.page-1)*PAGE_SIZE;
      var end=Math.min(total, start+PAGE_SIZE);
      pager.hidden=false;
      var html='';
      html+='<span class="meta">عرض '+(start+1)+'–'+end+' من '+total+'</span>';
      html+='<button class="pbtn" data-pg="prev"'+(State.page<=1?' disabled':'')+'>السابق</button>';
      var window=5; var s=Math.max(1, State.page-window), e=Math.min(pages, State.page+window);
      for(var i=s;i<=e;i++){
        html+='<button class="pbtn'+(i===State.page?' active':'')+'" data-page="'+i+'">'+i+'</button>';
      }
      html+='<button class="pbtn" data-pg="next"'+(State.page>=pages?' disabled':'')+'>التالي</button>';
      pager.innerHTML=html;
      return {start:start, end:end};
    }
    function render(){
      var data=Store.read();
      var list=applyFilters(data);
      buildTaxonomyOptions();
      renderSectionStats();
      var wrap=$('#cards'), empty=$('#empty');
      if(!list.length){ if(wrap) wrap.innerHTML=''; if(empty) empty.hidden=false; $('#pager').hidden=true; return; }
      if(empty) empty.hidden=true;
      var slice=renderPager(list.length);
      var view=list.slice(slice.start, slice.end);
      wrap.innerHTML = view.map(cardHTML).join('');
    }

    // ---------- Details View ----------
    function detailsHTML(p){
      var html='';
      var q=Product.qty(p);
      html+='<div class="row">';
      html+='<div><b>الاسم:</b> '+esc(p.name||'')+'</div>';
      html+='<div><b>SKU:</b> <code class="sku">'+esc(p.sku||'')+'</code> <button class="btn xs ghost" data-act="copy-sku" data-sku="'+esc(p.sku||'')+'">نسخ</button></div>';
      html+='<div><b>النوع:</b> '+(p.type==='simple'?'عادي':(p.type==='multi-color'?'متعدد (ألوان)':'متعدد (أحجام)'))+'</div>';
      html+='<div><b>المتبقي:</b> '+q+'</div>';
      if(p.section){ html+='<div><b>القسم:</b> '+esc(p.section)+'</div>'; }
      if(p.category){ html+='<div><b>الفئة:</b> '+esc(p.category)+'</div>'; }
      if(p.type==='simple'){ html+='<div><b>السعر:</b> '+(toNum(p.price)>0?fmt(p.price):'—')+'</div>'; }
      html+='</div>';
      if(p.desc){ html+='<div class="muted" style="margin:6px 0">'+esc(p.desc)+'</div>'; }
      var img=Product.cover(p); if(img){ html+='<div style="margin:8px 0"><img src="'+esc(img)+'" alt="'+esc(p.name||p.sku||"")+'" class="thumb-sm" style="width:100px;height:100px"></div>'; }
      if(p.type==='multi-color'){
        html+='<table class="mini-table"><thead><tr><th>اللون</th><th>الصورة</th><th>السعر</th><th>الكمية</th></tr></thead><tbody>';
        (p.colors||[]).forEach(function(c){
          html+='<tr><td>'+esc(c.label||'')+'</td><td>'+(c.image?'<img src="'+esc(c.image)+'" class="thumb-xs" style="display:block" alt="">':'—')+'</td><td>'+fmt(c.price||0)+'</td><td>'+toNum(c.qty||0)+'</td></tr>';
        });
        html+='</tbody></table>';
      } else if(p.type==='multi-size'){
        html+='<table class="mini-table"><thead><tr><th>الحجم</th><th>الصورة</th><th>السعر</th><th>الكمية</th></tr></thead><tbody>';
        (p.sizes||[]).forEach(function(sv){
          html+='<tr><td>'+esc(sv.size||'')+'</td><td>'+(sv.image?'<img src="'+esc(sv.image)+'" class="thumb-xs" style="display:block" alt="">':'—')+'</td><td>'+fmt(sv.price||0)+'</td><td>'+toNum(sv.qty||0)+'</td></tr>';
        });
        html+='</tbody></table>';
      }
      return html;
    }

    // ---------- Form ----------
    function resetForm(){
      $('#fmName').value=''; $('#fmSku').value=''; $('#fmPrice').value=''; $('#fmQty').value=''; $('#fmDesc').value='';
      $('#fmSection').value=''; $('#fmCategory').value='';
      $('#fmImage').value=''; $('#fmPreview').style.display='none'; $('#fmPreview').src='';
      $('#fmMulti').checked=false; $('#multiControls').style.display='none';
      $$('#multiControls input[type="radio"]').forEach(function(r){ r.checked=false; });
      $('#multiColorBox').style.display='none'; $('#multiSizeBox').style.display='none';
      $('#colorList').innerHTML=''; $('#sizeList').innerHTML='';
      $('#fmSave').dataset.mode='create'; $('#fmSave').dataset.sku='';
      resetDirty();
    }
    function fillForm(p){
      $('#fmName').value=p.name||''; $('#fmSku').value=p.sku||''; $('#fmDesc').value=p.desc||'';
      $('#fmSection').value=p.section||''; $('#fmCategory').value=p.category||'';
      if(p.type==='simple'){ $('#fmPrice').value=p.price||0; $('#fmQty').value=p.qty||0; if(p.image){ $('#fmPreview').src=p.image; $('#fmPreview').style.display='inline-block'; } }
      else { $('#fmPrice').value=''; $('#fmQty').value=''; $('#fmPreview').style.display='none'; $('#fmPreview').src=''; }
      if(p.type==='multi-color'){
        $('#fmMulti').checked=true; $('#multiControls').style.display='flex';
        $$('input[name="multiKind"]').forEach(function(r){ r.checked=(r.value==='color'); });
        $('#multiColorBox').style.display='block'; $('#multiSizeBox').style.display='none';
        $('#colorList').innerHTML='';
        (p.colors||[]).forEach(function(c){ addColorRow(c.label||'', c.price||0, c.qty||0, c.image||''); });
      } else if(p.type==='multi-size'){
        $('#fmMulti').checked=true; $('#multiControls').style.display='flex';
        $$('input[name="multiKind"]').forEach(function(r){ r.checked=(r.value==='size'); });
        $('#multiColorBox').style.display='none'; $('#multiSizeBox').style.display='block';
        $('#sizeList').innerHTML='';
        (p.sizes||[]).forEach(function(sv){ addSizeRow(sv.size||'', sv.price||0, sv.qty||0, sv.image||''); });
      } else {
        $('#fmMulti').checked=false; $('#multiControls').style.display='none';
        $('#multiColorBox').style.display='none'; $('#multiSizeBox').style.display='none';
        $('#colorList').innerHTML=''; $('#sizeList').innerHTML='';
      }
      $('#fmSave').dataset.mode='update'; $('#fmSave').dataset.sku=p.sku||'';
      resetDirty();
    }
    function readForm(){
      var multi=$('#fmMulti').checked, kind=null;
      if(multi){ var radios=$$('input[name="multiKind"]'); for(var i=0;i<radios.length;i++){ if(radios[i].checked){ kind=radios[i].value; break; } } }
      var base={
        name:($('#fmName').value||'').trim(),
        sku:($('#fmSku').value||'').trim(),
        desc:($('#fmDesc').value||'').trim(),
        section:($('#fmSection').value||'').trim(),
        category:($('#fmCategory').value||'').trim()
      };
      if(!multi){
        base.type='simple'; base.price=toNum($('#fmPrice').value||0); base.qty=toNum($('#fmQty').value||0); base.image=$('#fmPreview').src||'';
      } else if(kind==='color'){
        base.type='multi-color';
        base.colors = $$('#colorList .var-row').map(function(row){
          var img=row.querySelector('.v-image-preview');
          return { label:(row.querySelector('.v-label').value||'').trim(), price:toNum(row.querySelector('.v-price').value||0), qty:toNum(row.querySelector('.v-qty').value||0), image:img ? (img.getAttribute('src')||'') : '' };
        });
      } else {
        base.type='multi-size';
        base.sizes = $$('#sizeList .var-row.size').map(function(row){
          var img=row.querySelector('.v-image-preview');
          return { size:(row.querySelector('.v-size').value||'').trim(), price:toNum(row.querySelector('.v-price').value||0), qty:toNum(row.querySelector('.v-qty').value||0), image: img ? (img.getAttribute('src')||'') : '' };
        });
      }
      return base;
    }

    // Variant rows
    function addColorRow(label, price, qty, imageDataURL){
      var div=document.createElement('div'); div.className='var-row';
      div.innerHTML=[
        '<input class="v-label" type="text" placeholder="اسم اللون" value="'+(label||'')+'">',
        '<input class="v-price" type="number" step="0.001" placeholder="سعر" value="'+(price||0)+'">',
        '<input class="v-qty" type="number" step="1" placeholder="كمية" value="'+(qty||0)+'">',
        '<div class="file-inline"><input class="v-image" type="file" accept="image/*"><img class="v-image-preview thumb-xs" alt="" '+(imageDataURL?'src="'+imageDataURL+'" style="display:block"':'style="display:none"')+'></div>',
        '<button class="btn xs danger" type="button">حذف</button>'
      ].join('');
      var fileInp=div.querySelector('.v-image'), prev=div.querySelector('.v-image-preview');
      fileInp.addEventListener('change', function(){
        var f=this.files && this.files[0]; if(!f) return;
        handleImageInput(f, function(data){ if(data){ prev.src=data; prev.style.display='block'; setDirty(); toast('تم ضغط الصورة', {type:'success'});} else { toast('فشل تحميل الصورة', {type:'error'});} });
      });
      div.querySelector('button').onclick=function(){ div.parentNode.removeChild(div); setDirty(); };
      $('#colorList').appendChild(div); setDirty();
    }
    function addSizeRow(size, price, qty, imageDataURL){
      var div=document.createElement('div'); div.className='var-row size';
      div.innerHTML=[
        '<input class="v-size" type="text" placeholder="الحجم (S/M/L …)" value="'+(size||'')+'">',
        '<input class="v-price" type="number" step="0.001" placeholder="سعر" value="'+(price||0)+'">',
        '<input class="v-qty" type="number" step="1" placeholder="كمية" value="'+(qty||0)+'">',
        '<div class="file-inline"><input class="v-image" type="file" accept="image/*"><img class="v-image-preview thumb-xs" alt="" '+(imageDataURL?'src="'+imageDataURL+'" style="display:block"':'style="display:none"')+'></div>',
        '<button class="btn xs danger" type="button">حذف</button>'
      ].join('');
      var fileInp=div.querySelector('.v-image'), prev=div.querySelector('.v-image-preview');
      fileInp.addEventListener('change', function(){
        var f=this.files && this.files[0]; if(!f) return;
        handleImageInput(f, function(data){ if(data){ prev.src=data; prev.style.display='block'; setDirty(); toast('تم ضغط الصورة', {type:'success'});} else { toast('فشل تحميل الصورة', {type:'error'});} });
      });
      div.querySelector('button').onclick=function(){ div.parentNode.removeChild(div); setDirty(); };
      document.querySelector('#sizeList').appendChild(div); setDirty();
    }

    // ---------- Pane switch ----------
    function switchPane(which){
      var view=(which==='view');
      if(!view && $('#pane-edit').style.display==='none'){ resetDirty(); } // entering edit
      if(view && $('#pane-edit').style.display!=='none' && editDirty){
        if(!confirm('لديك تعديلات غير محفوظة. هل تريد تجاهلها والعودة للتفاصيل؟')) return;
      }
      $('#pane-view').style.display=view?'block':'none'; $('#pane-edit').style.display=view?'none':'block';
      $('#viewBtns').style.display=view?'flex':'none'; $('#editBtns').style.display=view?'none':'flex';
      $$('.tab').forEach(function(t){ t.classList.toggle('active', t.getAttribute('data-pane')===which); });
      if(view) resetDirty();
    }

    // ---------- Export / Import ----------
    function exportJSON(){
      var data=Store.read();
      var blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='products-export.json';
      document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },0);
      toast('تم تصدير JSON', {type:'success'});
    }
    function importJSON(file){
      var fr=new FileReader();
      fr.onload=function(e){
        try{
          var obj=JSON.parse(String(e.target.result||'[]'));
          if(!Array.isArray(obj)) throw new Error('تنسيق غير صالح');
          Store.write(obj); render(); toast('تم الاستيراد بنجاح', {type:'success'});
        }catch(err){ console.error(err); toast('فشل الاستيراد — تحقق من الملف', {type:'error'}); }
      };
      fr.onerror=function(){ toast('تعذر قراءة الملف', {type:'error'}); };
      fr.readAsText(file);
    }

    // ---------- App init ----------
    document.addEventListener('DOMContentLoaded', function(){
      Store.seed(); render();

      // search (debounced) + filters + sort + taxonomy
      var q=$('#q'); if(q){ q.addEventListener('input', debounce(function(){ State.q=String(this.value||'').trim(); State.page=1; render(); }, 200)); }
      var fltType=$('#fltType'); if(fltType){ fltType.addEventListener('change', function(){ State.type=this.value||'all'; State.page=1; render(); }); }
      var fltSection=$('#fltSection'); if(fltSection){ fltSection.addEventListener('change', function(){ State.section=this.value||'all'; State.page=1; render(); }); }
      var fltCategory=$('#fltCategory'); if(fltCategory){ fltCategory.addEventListener('change', function(){ State.category=this.value||'all'; State.page=1; render(); }); }
      var fltStock=$('#fltStock'); if(fltStock){ fltStock.addEventListener('change', function(){ State.stock=this.value||'all'; State.page=1; render(); }); }
      var sortQty=$('#sortQty'); if(sortQty){ sortQty.addEventListener('change', function(){ State.sort=this.value||'none'; State.page=1; render(); }); }

      // pager clicks
      on($('#pager'), 'click', '.pbtn', function(){
        var pg=this.getAttribute('data-page');
        var dir=this.getAttribute('data-pg');
        if(pg){ State.page=parseInt(pg)||1; render(); }
        else if(dir==='prev'){ State.page=Math.max(1, State.page-1); render(); }
        else if(dir==='next'){ State.page=State.page+1; render(); }
      });

      // open details via button on card
      on($('#cards'), 'click', '[data-act="details"]', function(){
        var card=this.closest('.card'); if(!card) return;
        var sku=card.getAttribute('data-sku');
        var list=Store.read(); var p=list.find(function(x){ return String(x.sku).toLowerCase()===String(sku).toLowerCase(); });
        if(!p) return;
        $('#ttl').textContent='تفاصيل المنتج — '+(p.name||p.sku);
        $('#pane-view').innerHTML=detailsHTML(p);
        fillForm(p); switchPane('view'); $('#fmSave').dataset.mode='update'; $('#fmSave').dataset.sku=p.sku||'';
        openModal();
      });

      // open create
      var btnAdd=$('#btnAdd');
      if(btnAdd){ btnAdd.addEventListener('click', function(){
        $('#ttl').textContent='إضافة منتج جديد'; resetForm(); switchPane('edit'); openModal();
      }); }

      // footer actions
      var btnGoEdit=$('#btnGoEdit'); if(btnGoEdit) btnGoEdit.addEventListener('click', function(){ switchPane('edit'); });
      var btnCloseView=$('#btnCloseView'); if(btnCloseView) btnCloseView.addEventListener('click', function(){ if(canClose()) closeModal(); });
      var btnCancel=$('#btnCancelEdit'); if(btnCancel) btnCancel.addEventListener('click', function(){ switchPane('view'); });

      // delete -> open confirm
      var btnDelete=$('#btnDelete');
      if(btnDelete){ btnDelete.addEventListener('click', function(){
        var sku=($('#fmSave').dataset.sku||'').trim();
        if(!sku){ toast('لا يوجد عنصر محدد للحذف', {type:'warn'}); return; }
        var list=Store.read(); var item=list.find(function(x){ return String(x.sku).toLowerCase()===String(sku).toLowerCase(); });
        if(!item){ toast('العنصر غير موجود', {type:'warn'}); return; }
        openDelModal(item);
      }); }

      // delete modal buttons
      var btnDelCancel=$('#btnDelCancel'); if(btnDelCancel){ btnDelCancel.addEventListener('click', function(){ closeDelModal(); }); }
      var btnDelConfirm=$('#btnDelConfirm'); if(btnDelConfirm){ btnDelConfirm.addEventListener('click', function(){
        var sku=$('#bdDel').dataset.sku||''; if(!sku){ toast('لا يوجد عنصر محدد للحذف', {type:'warn'}); return; }
        Store.remove(sku); render(); closeDelModal(); closeModal(); toast('تم حذف المنتج', {type:'success'});
      }); }
      var btnCopySku=$('#btnCopySku'); if(btnCopySku){ btnCopySku.addEventListener('click', function(){ var sku=$('#bdDel').dataset.sku||''; copyText(sku); }); }

      // copy SKU from details
      on($('#pane-view'), 'click', '[data-act="copy-sku"]', function(){ var sku=this.getAttribute('data-sku')||''; copyText(sku); });

      // image preview (main) with compression
      var fmImage=$('#fmImage'), fmPrev=$('#fmPreview');
      if(fmImage){ fmImage.addEventListener('change', function(){
        var f=this.files && this.files[0];
        if(!f){ fmPrev.style.display='none'; fmPrev.src=''; return; }
        handleImageInput(f, function(data){
          if(data){ fmPrev.src=data; fmPrev.style.display='block'; setDirty(); toast('تم ضغط الصورة', {type:'success'}); }
          else { toast('فشل تحميل الصورة', {type:'error'}); }
        });
      }); }

      // mark dirty on any input change in edit pane
      on($('#pane-edit'), 'input', 'input,textarea,select', function(){ setDirty(); });

      // multi toggle
      var fmMulti=$('#fmMulti'); if(fmMulti){ fmMulti.addEventListener('change', function(){
        var on=this.checked; $('#multiControls').style.display= on ? 'flex':'none'; setDirty();
        if(!on){ $('#multiColorBox').style.display='none'; $('#multiSizeBox').style.display='none'; $$('#multiControls input[type="radio"]').forEach(function(r){ r.checked=false; }); }
      }); }
      $$('#multiControls input[type="radio"]').forEach(function(r){
        r.addEventListener('change', function(){
          if(this.value==='color'){ $('#multiColorBox').style.display='block'; $('#multiSizeBox').style.display='none'; }
          else { $('#multiColorBox').style.display='none'; $('#multiSizeBox').style.display='block'; }
          setDirty();
        });
      });

      // add variant rows
      var btnColor=$('#btnColorAdd'); if(btnColor){ btnColor.addEventListener('click', function(){ addColorRow('',0,0,''); setDirty(); }); }
      var btnSize=$('#btnSizeAdd'); if(btnSize){ btnSize.addEventListener('click', function(){ addSizeRow('',0,0,''); setDirty(); }); }

      // save with SKU uniqueness check
      var save=$('#fmSave');
      if(save){ save.addEventListener('click', function(){
        var originalSku=(($('#fmSave').dataset.sku)||'').trim().toLowerCase();
        var mode=$('#fmSave').dataset.mode||'create';
        var item=readForm();
        if(!item.name || !item.sku){ toast('الاسم و كود المنتج مطلوبان', {type:'warn'}); return; }
        var all=Store.read();
        var dup=all.some(function(p){
          var same=String(p.sku||'').toLowerCase()===String(item.sku||'').toLowerCase();
          if(!same) return false;
          return mode==='create' || (mode==='update' && String(item.sku||'').toLowerCase()!==originalSku);
        });
        if(dup){ toast('SKU مستخدم مسبقًا — غيّره يدويًا', {type:'error'}); return; }

        if(item.type==='simple' && toNum(item.price)<=0){ toast('أدخل سعرًا صالحًا', {type:'warn'}); return; }
        if(item.type==='multi-color' && (!item.colors || item.colors.length===0)){ toast('أضف لونًا واحدًا على الأقل', {type:'warn'}); return; }
        if(item.type==='multi-size' && (!item.sizes || item.sizes.length===0)){ toast('أضف حجمًا واحدًا على الأقل', {type:'warn'}); return; }

        Store.upsert(item);
        render(); $('#pane-view').innerHTML=detailsHTML(item); fillForm(item);
        $('#fmSave').dataset.mode='update'; $('#fmSave').dataset.sku=item.sku||'';
        switchPane('view'); resetDirty(); toast('تم الحفظ بنجاح', {type:'success'});
      }); }

      // export/import buttons
      var btnExport=$('#btnExport'); if(btnExport){ btnExport.addEventListener('click', exportJSON); }
      var btnImport=$('#btnImport'); var fileImport=$('#fileImport');
      if(btnImport && fileImport){
        btnImport.addEventListener('click', function(){ fileImport.click(); });
        fileImport.addEventListener('change', function(){ var f=this.files && this.files[0]; if(f) importJSON(f); this.value=''; });
      }

      // Warn before unloading page if dirty
      window.addEventListener('beforeunload', function(e){ if(editDirty){ e.preventDefault(); e.returnValue=''; } });
    });
  })();
  </script>
</body>
</html>
